<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî Beauty Studio</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .admin-header {
        background: var(--card-bg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px 0;
        margin-bottom: 30px;
      }

      .admin-header__inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        border: 1px solid var(--card-border);
      }

      .stat-card__value {
        font-size: 32px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
      }

      .stat-card__label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .admin-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .admin-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--card-border);
      }

      .admin-table thead {
        background: rgba(255, 91, 155, 0.1);
      }

      .admin-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .admin-table td {
        padding: 14px 16px;
        font-size: 14px;
        color: #e4e4ff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .admin-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .admin-table tbody tr:last-child td {
        border-bottom: none;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge--upcoming {
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
      }

      .badge--past {
        background: rgba(160, 160, 184, 0.2);
        color: var(--text-muted);
      }

      .badge--today {
        background: rgba(255, 91, 155, 0.2);
        color: var(--primary);
      }

      .action-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        background: rgba(255, 91, 155, 0.2);
        border-color: var(--primary);
      }

      .action-btn--danger:hover {
        background: rgba(248, 113, 113, 0.2);
        border-color: #f87171;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      .empty-state__icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <div class="container admin-header__inner">
        <div>
          <h1 style="margin: 0; color: #fff; font-size: 24px;">
            –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
          </h1>
          <p style="margin: 4px 0 0; color: var(--text-muted); font-size: 14px;">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
          </p>
        </div>
        <div>
          <a href="index.html" class="btn btn--ghost">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
        </div>
      </div>
    </div>

    <main>
      <div class="container">
        <div class="admin-stats" id="admin-stats">
          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="admin-filters">
          <select id="filter-date" class="chip" style="padding: 8px 14px;">
            <option value="all">–í—Å–µ –¥–∞—Ç—ã</option>
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
            <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
            <option value="upcoming">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</option>
            <option value="past">–ü—Ä–æ—à–µ–¥—à–∏–µ</option>
          </select>
          <select id="filter-master" class="chip" style="padding: 8px 14px;">
            <option value="all">–í—Å–µ –º–∞—Å—Ç–µ—Ä–∞</option>
          </select>
          <select id="filter-service" class="chip" style="padding: 8px 14px;">
            <option value="all">–í—Å–µ —É—Å–ª—É–≥–∏</option>
          </select>
          <button
            id="export-btn"
            class="btn btn--ghost btn--small"
            style="margin-left: auto;"
          >
            –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
          </button>
        </div>

        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th>–£—Å–ª—É–≥–∞</th>
                <th>–ú–∞—Å—Ç–µ—Ä</th>
                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="admin-table-body">
              <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </tbody>
          </table>
        </div>

        <div id="admin-empty" class="empty-state" style="display: none;">
          <div class="empty-state__icon">üìÖ</div>
          <h3 style="color: #fff; margin: 0 0 8px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
          <p style="margin: 0;">
            –ó–∞–ø–∏—Å–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
          </p>
        </div>
      </div>
    </main>

    <script>
      const STORAGE_KEY = "beauty_studio_bookings_v1";

      function loadBookings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function saveBookings(bookings) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(bookings));
        } catch {
          // ignore
        }
      }

      function formatDateTime(value) {
        if (!value) return "";
        try {
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return value;

          return date.toLocaleString("ru-RU", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch {
          return value;
        }
      }

      function getBookingStatus(datetime) {
        const now = new Date();
        const bookingDate = new Date(datetime);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        bookingDate.setHours(0, 0, 0, 0);

        if (bookingDate.getTime() === today.getTime()) {
          return { type: "today", label: "–°–µ–≥–æ–¥–Ω—è" };
        } else if (bookingDate < today) {
          return { type: "past", label: "–ü—Ä–æ—à–µ–¥—à–∞—è" };
        } else {
          return { type: "upcoming", label: "–ü—Ä–µ–¥—Å—Ç–æ—è—â–∞—è" };
        }
      }

      function renderStats(bookings) {
        const statsContainer = document.getElementById("admin-stats");
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay() + 1);

        const total = bookings.length;
        const todayBookings = bookings.filter(
          (b) => new Date(b.datetime).setHours(0, 0, 0, 0) === today.getTime()
        ).length;
        const weekBookings = bookings.filter(
          (b) => new Date(b.datetime) >= weekStart
        ).length;
        const upcomingBookings = bookings.filter(
          (b) => new Date(b.datetime) > now
        ).length;

        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-card__value">${total}</div>
            <div class="stat-card__label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">${todayBookings}</div>
            <div class="stat-card__label">–°–µ–≥–æ–¥–Ω—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">${weekBookings}</div>
            <div class="stat-card__label">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">${upcomingBookings}</div>
            <div class="stat-card__label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
          </div>
        `;
      }

      function filterBookings(bookings, dateFilter, masterFilter, serviceFilter) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay() + 1);
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

        return bookings.filter((booking) => {
          const bookingDate = new Date(booking.datetime);

          // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
          if (dateFilter === "today") {
            if (bookingDate.setHours(0, 0, 0, 0) !== today.getTime()) {
              return false;
            }
          } else if (dateFilter === "week") {
            if (bookingDate < weekStart) {
              return false;
            }
          } else if (dateFilter === "month") {
            if (bookingDate < monthStart) {
              return false;
            }
          } else if (dateFilter === "upcoming") {
            if (bookingDate <= now) {
              return false;
            }
          } else if (dateFilter === "past") {
            if (bookingDate > now) {
              return false;
            }
          }

          // –§–∏–ª—å—Ç—Ä –ø–æ –º–∞—Å—Ç–µ—Ä—É
          if (masterFilter !== "all" && booking.master !== masterFilter) {
            return false;
          }

          // –§–∏–ª—å—Ç—Ä –ø–æ —É—Å–ª—É–≥–µ
          if (serviceFilter !== "all" && booking.service !== serviceFilter) {
            return false;
          }

          return true;
        });
      }

      function renderTable(bookings) {
        const tbody = document.getElementById("admin-table-body");
        const empty = document.getElementById("admin-empty");

        if (!bookings.length) {
          tbody.innerHTML = "";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";

        const sortedBookings = [...bookings].sort(
          (a, b) => new Date(a.datetime) - new Date(b.datetime)
        );

        tbody.innerHTML = sortedBookings
          .map((booking) => {
            const status = getBookingStatus(booking.datetime);
            return `
              <tr>
                <td>${formatDateTime(booking.datetime)}</td>
                <td><strong>${booking.name}</strong></td>
                <td>${booking.phone}</td>
                <td>${booking.service}</td>
                <td>${booking.master || "–ù–µ —É–∫–∞–∑–∞–Ω"}</td>
                <td>${booking.comment || "‚Äî"}</td>
                <td><span class="badge badge--${status.type}">${status.label}</span></td>
                <td>
                  <button class="action-btn action-btn--danger" onclick="deleteBooking(${booking.id})">
                    –£–¥–∞–ª–∏—Ç—å
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      function populateFilters(bookings) {
        const masters = [...new Set(bookings.map((b) => b.master).filter(Boolean))];
        const services = [...new Set(bookings.map((b) => b.service).filter(Boolean))];

        const masterSelect = document.getElementById("filter-master");
        masters.forEach((master) => {
          const option = document.createElement("option");
          option.value = master;
          option.textContent = master;
          masterSelect.appendChild(option);
        });

        const serviceSelect = document.getElementById("filter-service");
        services.forEach((service) => {
          const option = document.createElement("option");
          option.value = service;
          option.textContent = service;
          serviceSelect.appendChild(option);
        });
      }

      function updateView() {
        const allBookings = loadBookings();
        const dateFilter = document.getElementById("filter-date").value;
        const masterFilter = document.getElementById("filter-master").value;
        const serviceFilter = document.getElementById("filter-service").value;

        const filtered = filterBookings(
          allBookings,
          dateFilter,
          masterFilter,
          serviceFilter
        );

        renderStats(allBookings);
        renderTable(filtered);
      }

      window.deleteBooking = function (id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;

        const bookings = loadBookings();
        const filtered = bookings.filter((b) => b.id !== id);
        saveBookings(filtered);
        updateView();
      };

      function exportToCSV() {
        const bookings = loadBookings();
        const dateFilter = document.getElementById("filter-date").value;
        const masterFilter = document.getElementById("filter-master").value;
        const serviceFilter = document.getElementById("filter-service").value;

        const filtered = filterBookings(
          bookings,
          dateFilter,
          masterFilter,
          serviceFilter
        );

        const headers = [
          "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è",
          "–ö–ª–∏–µ–Ω—Ç",
          "–¢–µ–ª–µ—Ñ–æ–Ω",
          "–£—Å–ª—É–≥–∞",
          "–ú–∞—Å—Ç–µ—Ä",
          "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        ];
        const rows = filtered.map((b) => [
          formatDateTime(b.datetime),
          b.name,
          b.phone,
          b.service,
          b.master || "",
          b.comment || "",
        ]);

        const csv =
          headers.join(",") +
          "\n" +
          rows.map((row) => row.map((cell) => `"${cell}"`).join(",")).join("\n");

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `bookings_${new Date().toISOString().split("T")[0]}.csv`;
        link.click();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.getElementById("filter-date").addEventListener("change", updateView);
      document.getElementById("filter-master").addEventListener("change", updateView);
      document.getElementById("filter-service").addEventListener("change", updateView);
      document.getElementById("export-btn").addEventListener("click", exportToCSV);

      const allBookings = loadBookings();
      populateFilters(allBookings);
      updateView();

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      setInterval(() => {
        updateView();
      }, 30000);
    </script>
  </body>
</html>
